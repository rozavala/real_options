name: Deploy Trading Bot

# This action runs on every push to the 'main' branch
#
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.5.2
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to Droplet and Restart Bot
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} '
            # Navigate to your project directory
            cd ~/real_options &&

            # Stop the old trading bot process if it is running
            echo "Attempting to stop the old bot..."
            pkill -f prob_coffee_options.py || true &&

            # Pull the latest code from the main branch
            echo "Pulling latest code..."
            git pull &&

            # Activate virtual environment and start the new bot in the background
            echo "Starting the new bot..."
            source ~/Desktop/ib_env/bin/activate &&
            nohup python -u ~/real_options/prob_coffee_options.py >> ~/real_options/logs/trading_bot.log 2>&1 &
          '
